# Reference

<!-- DO NOT EDIT: This document was generated by Puppet Strings -->

## Table of Contents

### Functions

* [`pam_tools::calculate_pe_memory`](#pam_toolscalculate_pe_memory): This is a crude memory allocation system that is tuned for the base, minimal test memory instance of 4.5GB.  This allows you to spin up Conne
* [`pam_tools::check_for_file`](#pam_toolscheck_for_file): Raises an error if the given file path does not exist or cannot be read.
* [`pam_tools::generate_random_password`](#pam_toolsgenerate_random_password): Generate a random password of the given length using Ruby's SecureRandom library.
* [`pam_tools::generate_randomized_name`](#pam_toolsgenerate_randomized_name): Given a stem and optional character count, return a name with a random extension. Useful for generating randomized temp directories, for exam
* [`pam_tools::get_kots_app`](#pam_toolsget_kots_app): Return the application name based on kots_slug and entitlement from the given license file.
* [`pam_tools::get_kots_slug`](#pam_toolsget_kots_slug): Return the appSlug from a given license file.

### Data types

* [`Pam_tools::Absolute_path`](#pam_toolsabsolute_path): Pattern ensuring a path begins with a POSIX '/', a Windows 'C:\' or '\', or a 'puppet:/' module file uri.

### Tasks

* [`delete_k8s_app_resources`](#delete_k8s_app_resources): Delete the kubernetes resources for a given replicated app. Does not remove the app from the Replicated admin console, which allows for re-in
* [`delete_kots_app`](#delete_kots_app): Use kubectl-kots to delete an instance of a Replicated app from the Kots admin-console. Note that this does not delete the application resour
* [`delete_kotsadm`](#delete_kotsadm): Delete the Kots admin-console applicaiton from the cluster. Note, if you use this on a Kurl host, you will need to re-run the Kurl installer 
* [`destroy_nginx_ingress`](#destroy_nginx_ingress): Tear down the Nginx IngressController.
* [`get_kots_app_status`](#get_kots_app_status): Return the state of a given Kots application, or not-installed. Will also return not-installed if kots itself is not installed.
* [`helm_install_chart`](#helm_install_chart): Install or upgrade a helm chart.
* [`kots_download`](#kots_download): Downloads the currently installed source of a given Kots application from the admin console to the given directory. This task is a wrapper ro
* [`kots_install`](#kots_install): Install a Replicated application with kubectl-kots for testing. This task takes several shortcuts for configuration and security which are no
* [`kots_upload`](#kots_upload): Upload the given source directory on the target host to the Kots admin-console, and optionally deploy it. Assumes a version of the applicatio
* [`list_container_images`](#list_container_images): Utility for inspecting all the image references from deployment and statefulset container and initContainers in the given namespace.
* [`start_nginx_ingress`](#start_nginx_ingress): Starts an Nginx IngressController in the cluster. (https://github.com/kubernetes/ingress-nginx)
* [`update_image`](#update_image): Patch all deployments and statefulset container images matching the given +image_name+ to the given +image_version+.
* [`wait_for_app`](#wait_for_app): Wait for a Replicated app to deploy and any statefulsets to be ready.
* [`wait_for_rollout`](#wait_for_rollout): Wait for rollout of a set of Deployments and Statefulsets based on a k8s selector.

### Plans

* [`pam_tools::install_published`](#pam_toolsinstall_published): Install a published Replicated application via kubectl-kots.  Runs kubectl-kots with the given license and configuration and waits for deploy
* [`pam_tools::teardown`](#pam_toolsteardown): In successive tiers, teardown the application, it's admin-console metadata, and the Kots admin-console itself, if desired.  By default, just 

## Functions

### <a name="pam_toolscalculate_pe_memory"></a>`pam_tools::calculate_pe_memory`

Type: Puppet Language

This is a crude memory allocation system that is tuned for the base,
minimal test memory instance of 4.5GB.

This allows you to spin up Connect on an 8GB test host with the PE
components squeezed down into:

  pam_tools::calculate_pe_memory(4.5)
  #
  # {
  #   'console_memory'           => 768,
  #   'postgres_console_memory'  => 256,
  #   'puppetdb_memory'          => 768,
  #   'postgres_puppetdb_memory' => 512,
  #   'orchestrator_memory'      => 768,
  #   'postgres_orch_memory'     => 256,
  #   'boltserver_memory'        => 256,
  #   'puppetserver_memory'      => 1024,
  # }

Leaving remaining memory for the rest of Connect and system.

Greater memory can be allocated to PE as a whole, but the function simply
scales linearly, and consequently, this starts to distort the practical
memory allocation, since, for example, the console is unlikely to need much
more, whereas postgres might. Still you can bump up PE to 8GB or more quickly
this way without providing a custom values.yaml.

#### `pam_tools::calculate_pe_memory(Variant[Float,Integer] $allocated_memory_in_gigabytes)`

This is a crude memory allocation system that is tuned for the base,
minimal test memory instance of 4.5GB.

This allows you to spin up Connect on an 8GB test host with the PE
components squeezed down into:

  pam_tools::calculate_pe_memory(4.5)
  #
  # {
  #   'console_memory'           => 768,
  #   'postgres_console_memory'  => 256,
  #   'puppetdb_memory'          => 768,
  #   'postgres_puppetdb_memory' => 512,
  #   'orchestrator_memory'      => 768,
  #   'postgres_orch_memory'     => 256,
  #   'boltserver_memory'        => 256,
  #   'puppetserver_memory'      => 1024,
  # }

Leaving remaining memory for the rest of Connect and system.

Greater memory can be allocated to PE as a whole, but the function simply
scales linearly, and consequently, this starts to distort the practical
memory allocation, since, for example, the console is unlikely to need much
more, whereas postgres might. Still you can bump up PE to 8GB or more quickly
this way without providing a custom values.yaml.

Returns: `Any` Hash of memory resource limits in megabytes, keyed by service. This
is suitable for settings for the Helm chart or Connect application config.

##### `allocated_memory_in_gigabytes`

Data type: `Variant[Float,Integer]`

The number of gigabytes allocated specifically to PE. In Connect,
for example, you could set this to half the system memory. But the
minimum it will allocate is 4.5GB.

### <a name="pam_toolscheck_for_file"></a>`pam_tools::check_for_file`

Type: Puppet Language

Raises an error if the given file path does not exist or cannot be read.

#### `pam_tools::check_for_file(String $filetype, Optional[String] $path = undef, Boolean $fail_empty_path = true)`

Raises an error if the given file path does not exist or cannot be read.

Returns: `Any` The +path+ if found, or undef if no path given.

##### `filetype`

Data type: `String`

Type of file to display in error messages.

##### `path`

Data type: `Optional[String]`

To the file.

##### `fail_empty_path`

Data type: `Boolean`

If true, fail if no +path+ parameter is given.

### <a name="pam_toolsgenerate_random_password"></a>`pam_tools::generate_random_password`

Type: Ruby 4.x API

Generate a random password of the given length using Ruby's SecureRandom library.

#### `pam_tools::generate_random_password(Integer $length)`

Generate a random password of the given length using Ruby's SecureRandom library.

Returns: `String` The password string.

##### `length`

Data type: `Integer`

The number of characters to generate.

### <a name="pam_toolsgenerate_randomized_name"></a>`pam_tools::generate_randomized_name`

Type: Puppet Language

Given a stem and optional character count, return a name with a random extension.
Useful for generating randomized temp directories, for example.

Seeding is not tied to host(s), and should be random for each call.

#### Examples

##### 

```puppet
$r = pam_tools::generate_randomized_name('test', 12)
notice($r)
# Notice: Scope(Class[main]): test.x5gghIjk32ld
```

#### `pam_tools::generate_randomized_name(String $stem, Integer $count = 10)`

Given a stem and optional character count, return a name with a random extension.
Useful for generating randomized temp directories, for example.

Seeding is not tied to host(s), and should be random for each call.

Returns: `Any` A random string of the form '${stem}.${_random_char_ * ${count}}'

##### Examples

###### 

```puppet
$r = pam_tools::generate_randomized_name('test', 12)
notice($r)
# Notice: Scope(Class[main]): test.x5gghIjk32ld
```

##### `stem`

Data type: `String`

The start of the string.

##### `count`

Data type: `Integer`

Number of randomized characters to add as a suffix.

### <a name="pam_toolsget_kots_app"></a>`pam_tools::get_kots_app`

Type: Puppet Language

Return the application name based on kots_slug and entitlement from the given
license file.

#### `pam_tools::get_kots_app(String $license)`

Return the application name based on kots_slug and entitlement from the given
license file.

Returns: `Any` The associated application name (which may differ from kots_slug).

Raises:

* `PuppetError` If appSlug cannot be found in the license.

##### `license`

Data type: `String`

A String of the license file content.

### <a name="pam_toolsget_kots_slug"></a>`pam_tools::get_kots_slug`

Type: Puppet Language

Return the appSlug from a given license file.

#### `pam_tools::get_kots_slug(String $license)`

Return the appSlug from a given license file.

Returns: `Any` The appSlug string from the parsed license spec.

Raises:

* `PuppetError` If appSlug cannot be found.

##### `license`

Data type: `String`

A String of the license file content.

## Data types

### <a name="pam_toolsabsolute_path"></a>`Pam_tools::Absolute_path`

Pattern ensuring a path begins with a POSIX '/',
a Windows 'C:\' or '\',
or a 'puppet:/' module file uri.

Alias of

```puppet
Pattern[/^(\/.*|\\|[A-Z]:\\|puppet:\/)/]
```

## Tasks

### <a name="delete_k8s_app_resources"></a>`delete_k8s_app_resources`

Delete the kubernetes resources for a given replicated app. Does not remove the app from the Replicated admin console, which allows for re-installing from subsequent application uploads.

**Supports noop?** false

#### Parameters

##### `kots_namespace`

Data type: `String`

The k8s namespace we're operating in.

##### `kots_slug`

Data type: `String`

The Replicated application slug.

##### `scaledown_timeout`

Data type: `Integer`

Seconds to wait for app to scale down to 0 replica before deletion of all related resources.

### <a name="delete_kots_app"></a>`delete_kots_app`

Use kubectl-kots to delete an instance of a Replicated app from the Kots admin-console. Note that this does not delete the application resources from kubernetes.

**Supports noop?** false

#### Parameters

##### `kots_slug`

Data type: `Variant[Array[String],String]`

The replicated application slug to delete. Or '*' to delete all listed applications from the admin-console.

##### `kots_namespace`

Data type: `String`

The k8s namespace the application is installed in.

##### `force`

Data type: `Boolean`

Remove the application reference from the console even if it was already deployed.

### <a name="delete_kotsadm"></a>`delete_kotsadm`

Delete the Kots admin-console applicaiton from the cluster. Note, if you use this on a Kurl host, you will need to re-run the Kurl installer to set kotsadm back up again as `kubectl-kots install` will not be sufficient to install a kotsadm configured to work properly in the Kurl cluster..

**Supports noop?** false

#### Parameters

##### `kots_namespace`

Data type: `String`

The k8s namespace we're operating in.

##### `scaledown_timeout`

Data type: `Integer`

Seconds to wait for app to scale down to 0 replica before deletion of all related resources.

### <a name="destroy_nginx_ingress"></a>`destroy_nginx_ingress`

Tear down the Nginx IngressController.

**Supports noop?** false

### <a name="get_kots_app_status"></a>`get_kots_app_status`

Return the state of a given Kots application, or not-installed. Will also return not-installed if kots itself is not installed.

**Supports noop?** false

#### Parameters

##### `kots_slug`

Data type: `String`

The replicated application slug.

##### `kots_namespace`

Data type: `String`

The k8s namespace the application is installed in.

##### `verbose`

Data type: `Boolean`

Return json output, including the full hash of all Kots applicaiton statuses.

### <a name="helm_install_chart"></a>`helm_install_chart`

Install or upgrade a helm chart.

**Supports noop?** false

#### Parameters

##### `chart`

Data type: `String`

The chart to install. This could be a reference to a chart in a helm repository, or a path to a chart archive or directory.

##### `version`

Data type: `Optional[String]`

If +chart+ is a reference, this is the version to install. If not set, the latest version is installed.

##### `release`

Data type: `String`

The name of the installed instance of the chart.

##### `values`

Data type: `Optional[String]`

YAML override values for chart settings.

##### `namespace`

Data type: `String`

k8s namespace we're installing into.

##### `kubeconfig`

Data type: `String`

The path to the k8s config file needed to access the cluster we're installing into.

### <a name="kots_download"></a>`kots_download`

Downloads the currently installed source of a given Kots application from the admin console to the given directory. This task is a wrapper round `kubectl-kots download`.

**Supports noop?** false

#### Parameters

##### `kots_slug`

Data type: `String`

The replicated application slug.

##### `kots_namespace`

Data type: `String`

The k8s namespace we're operating in.

##### `destination`

Data type: `Optional[String]`

The absolute path to the directory to download the application source to. If not given, will default to '/tmp/${kots_slug}'.

##### `clear_upstream`

Data type: `Boolean`

Whether to delete the yaml manifests from the upstream folder after download. This is useful if we are going to replace it with newer upstream source before uploading back to the admin-console for deployment.

### <a name="kots_install"></a>`kots_install`

Install a Replicated application with kubectl-kots for testing. This task takes several shortcuts for configuration and security which are not suitable for production use. It is not idempotent.

**Supports noop?** false

#### Parameters

##### `license_content`

Data type: `String`

YAML contents of the license file for the replicated application to install

##### `password`

Data type: `String[6]`

Password to use for the kots admin-console, for the application, and possibly for any other internal passwords (databases?) in the generated app config.

##### `hostname`

Data type: `String`

The resolvable hostname to use when configuring the application.

##### `kots_namespace`

Data type: `String`

The k8s namespace we're operating in.

##### `kots_wait_duration`

Data type: `String`

Timeout waiting for admin-console.

##### `config_content`

Data type: `Optional[String]`

YAML configuration for an automated install of the replicated application. If not provided, a basic config will be generated by the task.

##### `kots_install_options`

Data type: `Optional[String]`

Additional parameters to pass to `kubectl-kots install`.

##### `airgap_bundle`

Data type: `Optional[String]`

Path on the target of an airgap bundle to install instead of using online installation.

##### `pam_variant`

Data type: `String`

The initial puppet-application-manager channel that will provide configuration for Kots.

### <a name="kots_upload"></a>`kots_upload`

Upload the given source directory on the target host to the Kots admin-console, and optionally deploy it. Assumes a version of the application is already installed. This task is a wrapper around `kubectl-kots upload`.

**Supports noop?** false

#### Parameters

##### `kots_slug`

Data type: `String`

The replicated application slug.

##### `kots_namespace`

Data type: `String`

The k8s namespace we're operating in.

##### `source`

Data type: `String`

The absolute path to the source directory to upload.

##### `deploy`

Data type: `Boolean`

Whether to have the admin-console deploy after uploading.

##### `skip_preflights`

Data type: `Boolean`

Whether to skip preflight checks after uploading.

### <a name="list_container_images"></a>`list_container_images`

Utility for inspecting all the image references from deployment and statefulset container and initContainers in the given namespace.

**Supports noop?** false

#### Parameters

##### `kots_namespace`

Data type: `String`

The k8s namespace we're operating in.

### <a name="start_nginx_ingress"></a>`start_nginx_ingress`

Starts an Nginx IngressController in the cluster. (https://github.com/kubernetes/ingress-nginx)

**Supports noop?** false

#### Parameters

##### `version`

Data type: `String`

The controller version to install in the cluster.

##### `provider`

Data type: `String`

The provider implementation to use.

##### `timeout`

Data type: `Integer`

Number of secs to wait for controller to be ready.

### <a name="update_image"></a>`update_image`

Patch all deployments and statefulset container images matching the given +image_name+ to the given +image_version+.

**Supports noop?** false

#### Parameters

##### `image_name`

Data type: `String`

This can be the short name, or the full name for the image including registry (everything to the left of the ':' version/tag separator).

##### `image_version`

Data type: `String`

The new version to patch the image to.

##### `kots_namespace`

Data type: `String`

The k8s namespace we're operating in.

### <a name="wait_for_app"></a>`wait_for_app`

Wait for a Replicated app to deploy and any statefulsets to be ready.

**Supports noop?** false

#### Parameters

##### `kots_slug`

Data type: `String`

Replicated slug for the application.

##### `app_hostname`

Data type: `String`

Resolvable hostname to reach the application locally.

##### `kots_namespace`

Data type: `String`

The k8s namspace we're operating in.

##### `app_timeout`

Data type: `Pattern[/[0-9]+s/]`

Number of seconds to wait for app to deploy.

##### `sts_timeout`

Data type: `Pattern[/[0-9]+s/]`

Number of seconds to wait for Deployment and StatefulSet rollouts to complete.

##### `http_timeout`

Data type: `Pattern[/[0-9]+s/]`

Number of seconds to wait for app http/s to return 'ok'

### <a name="wait_for_rollout"></a>`wait_for_rollout`

Wait for rollout of a set of Deployments and Statefulsets based on a k8s selector.

**Supports noop?** false

#### Parameters

##### `selector`

Data type: `String`

A k8s selector to constrain resources.

##### `namespace`

Data type: `String`

The k8s namespace to operate in

##### `timeout`

Data type: `Pattern[/[0-9]+s/]`

Number of seconds to wait for Deployment and StatefulSet rollouts to complete.

## Plans

### <a name="pam_toolsinstall_published"></a>`pam_tools::install_published`

Install a published Replicated application via kubectl-kots.

Runs kubectl-kots with the given license and configuration and waits for
deployment.

If no application configuration file is given, a very basic configuration file is
generated by the task, using the given password, for automated installation.

The `kubectl-kots install` will also install the Replicated Kots admin-console as
a side effect if not already installed into the cluster. Initial configuration
for Kots comes from one of the puppet-application-manager channels as determined
by the +pam_variant+ parameter. By default Kots is installed with
puppet-application-manager/stable.

Because `kubectl-kots install` is not an idempotent operation, if the plan
detects that the application has already been installed, it will skip this
step and simply wait for the application to be ready.

#### Parameters

The following parameters are available in the `pam_tools::install_published` plan:

* [`targets`](#targets)
* [`license_file`](#license_file)
* [`password`](#password)
* [`config_file`](#config_file)
* [`airgap_bundle`](#airgap_bundle)
* [`kots_install_options`](#kots_install_options)
* [`pam_variant`](#pam_variant)
* [`allocated_memory_in_gigabytes`](#allocated_memory_in_gigabytes)
* [`wait_for_app`](#wait_for_app)
* [`app_timeout`](#app_timeout)

##### <a name="targets"></a>`targets`

Data type: `TargetSpec`

The hosts to operate on.

##### <a name="license_file"></a>`license_file`

Data type: `Pam_tools::Absolute_path`

Path to the application license file.

##### <a name="password"></a>`password`

Data type: `Optional[String[6]]`

Password to use for both the Kots admin-console and for the application itself
(if not present in the config_file). If no password is given, one will be
randomly generated, and you will need to use `kubectl kots reset-password`.

Default value: ``undef``

##### <a name="config_file"></a>`config_file`

Data type: `Optional[Pam_tools::Absolute_path]`

Absolute path to application configuration defaults. If not provided, a
basic config will be generated by the install task.

Default value: ``undef``

##### <a name="airgap_bundle"></a>`airgap_bundle`

Data type: `Optional[Pam_tools::Absolute_path]`

Installs the application from an airgap bundle. Must be an absolute path.

Default value: ``undef``

##### <a name="kots_install_options"></a>`kots_install_options`

Data type: `Optional[String]`

Any additional command line options to pass directly to `kubectl-kots
install` when the kots_install task is run. (--skip-preflights=true, or
--skip-rbac-check=true, for example...)

Default value: ``undef``

##### <a name="pam_variant"></a>`pam_variant`

Data type: `String`

The initial puppet-application-manager channel that will provide
configuration for Kots itself prior to Kots installing the application
identified by the +license_content+. This can be important for a
GKE cluster, for example, which will require 'minimal-rbac' instead of
'stable' unless the service-account used has permissions to modify
clusteroles.

Default value: `'stable'`

##### <a name="allocated_memory_in_gigabytes"></a>`allocated_memory_in_gigabytes`

Data type: `Variant[Integer,Float]`

The total system memory being made available to the application.
This should be in integer or float gigabytes. This is used to
tune configuration for the app. It will be ignored if you are
supplying your own +config_file+, or for any application other
than Connect.

Default value: `16`

##### <a name="wait_for_app"></a>`wait_for_app`

Data type: `Boolean`

Whether or not to wait for app deployment to complete before returning.

Default value: ``true``

##### <a name="app_timeout"></a>`app_timeout`

Data type: `Integer`

If waiting for the app, this is the number of seconds to wait for kots
to indicate that the app is ready.

Default value: `600`

### <a name="pam_toolsteardown"></a>`pam_tools::teardown`

In successive tiers, teardown the application, it's admin-console
metadata, and the Kots admin-console itself, if desired.

By default, just deletes the given app's resources, allowing
for a fresh deployment.

#### Parameters

The following parameters are available in the `pam_tools::teardown` plan:

* [`targets`](#targets)
* [`kots_slug`](#kots_slug)
* [`kots_namespace`](#kots_namespace)
* [`scaledown_timeout`](#scaledown_timeout)
* [`remove_app_from_console`](#remove_app_from_console)
* [`delete_kotsadm`](#delete_kotsadm)

##### <a name="targets"></a>`targets`

Data type: `TargetSpec`

The hosts to operate on.

##### <a name="kots_slug"></a>`kots_slug`

Data type: `String`

The slug label of the Replicated application to delete.

##### <a name="kots_namespace"></a>`kots_namespace`

Data type: `String`

The k8s namespace the application is installed in.

Default value: `'default'`

##### <a name="scaledown_timeout"></a>`scaledown_timeout`

Data type: `Integer`

The number of seconds to wait for the application to scale down while
deleting resources.

Default value: `300`

##### <a name="remove_app_from_console"></a>`remove_app_from_console`

Data type: `Boolean`

If true, then the application metadata will also be deleted from the
admin-console. The next installation via `kubectl-kots install` will
recreate a fresh entry for the application in the console.

Default value: ``false``

##### <a name="delete_kotsadm"></a>`delete_kotsadm`

Data type: `Boolean`

If true, then the Kotsadm admin-console will also be deleted from
the cluster. It should be reinstalled by the next `kubectl-kots install`
command.

Default value: ``false``

